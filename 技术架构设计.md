# 达梦在线文档中心 - 技术架构设计

## 1. 整体架构概览

### 1.1 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        用户层                                │
├─────────────────┬─────────────────┬─────────────────────────┤
│   PC端浏览器     │   平板端浏览器    │      手机端浏览器        │
└─────────────────┴─────────────────┴─────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      前端层 (Vue.js 3)                      │
├─────────────────┬─────────────────┬─────────────────────────┤
│   文档展示模块   │    编辑器模块    │      权限管理模块        │
├─────────────────┼─────────────────┼─────────────────────────┤
│   搜索模块      │    版本管理模块   │      文件管理模块        │
└─────────────────┴─────────────────┴─────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    API网关层 (Nginx)                        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                  后端服务层 (Spring Boot)                   │
├─────────────────┬─────────────────┬─────────────────────────┤
│  用户权限服务    │   文档管理服务   │     文件处理服务         │
├─────────────────┼─────────────────┼─────────────────────────┤
│   搜索服务      │   版本管理服务    │     统计分析服务         │
└─────────────────┴─────────────────┴─────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        数据层                               │
├─────────────────┬─────────────────┬─────────────────────────┤
│   DM8数据库     │   Redis缓存      │    Elasticsearch        │
├─────────────────┼─────────────────┼─────────────────────────┤
│   文件存储      │   日志系统       │      监控系统           │
└─────────────────┴─────────────────┴─────────────────────────┘
```

### 1.2 技术栈选择

**前端技术栈**:
- **框架**: Vue.js 3 + TypeScript
- **UI组件库**: Element Plus
- **构建工具**: Vite
- **状态管理**: Pinia
- **路由管理**: Vue Router 4
- **HTTP客户端**: Axios
- **富文本编辑器**: TinyMCE
- **代码高亮**: Prism.js

**后端技术栈**:
- **框架**: Spring Boot 2.7+
- **安全框架**: Spring Security + JWT
- **ORM框架**: MyBatis Plus
- **数据库**: DM8 (达梦数据库)
- **缓存**: Redis (DMCDM)
- **搜索引擎**: Elasticsearch
- **文档处理**: Apache POI, iText, CommonMark
- **文件存储**: 本地文件系统 + MinIO (可选)

**运维技术栈**:
- **Web服务器**: Nginx
- **应用服务器**: Tomcat (内嵌)
- **容器化**: Docker + Docker Compose
- **监控**: Prometheus + Grafana
- **日志**: Logback + ELK Stack

## 2. 详细架构设计

### 2.1 前端架构设计

#### 2.1.1 项目结构
```
src/
├── components/          # 公共组件
│   ├── Editor/          # 富文本编辑器组件
│   ├── FileUpload/      # 文件上传组件
│   ├── TreeView/        # 树形目录组件
│   └── SearchBox/       # 搜索框组件
├── views/               # 页面组件
│   ├── Dashboard/       # 仪表板
│   ├── Document/        # 文档管理
│   ├── Category/        # 目录管理
│   └── User/           # 用户管理
├── router/             # 路由配置
├── store/              # 状态管理
├── api/                # API接口
├── utils/              # 工具函数
└── assets/             # 静态资源
```

#### 2.1.2 核心组件设计

**文档编辑器组件**:
```typescript
// DocumentEditor.vue
<template>
  <div class="document-editor">
    <div class="editor-toolbar">
      <el-button @click="save">保存</el-button>
      <el-button @click="preview">预览</el-button>
    </div>
    <div class="editor-content">
      <tinymce-editor
        v-model="content"
        :options="editorOptions"
        @change="handleContentChange"
      />
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue'
import TinymceEditor from '@/components/TinymceEditor.vue'

const content = ref('')
const editorOptions = computed(() => ({
  height: 600,
  plugins: 'code table link image',
  toolbar: 'bold italic | table link image | code'
}))

const save = () => {
  // 保存逻辑
}

const preview = () => {
  // 预览逻辑
}
</script>
```

**目录树组件**:
```typescript
// CategoryTree.vue
<template>
  <el-tree
    :data="treeData"
    :props="treeProps"
    draggable
    @node-drop="handleNodeDrop"
    @node-click="handleNodeClick"
  >
    <template #default="{ node, data }">
      <span class="tree-node">
        <span>{{ node.label }}</span>
        <span class="tree-actions">
          <el-button size="mini" @click="editNode(data)">编辑</el-button>
          <el-button size="mini" @click="deleteNode(data)">删除</el-button>
        </span>
      </span>
    </template>
  </el-tree>
</template>
```

### 2.2 后端架构设计

#### 2.2.1 项目结构
```
src/main/java/com/dameng/doc/
├── controller/          # 控制器层
│   ├── DocumentController.java
│   ├── CategoryController.java
│   ├── UserController.java
│   └── SearchController.java
├── service/            # 服务层
│   ├── DocumentService.java
│   ├── CategoryService.java
│   ├── UserService.java
│   └── SearchService.java
├── mapper/             # 数据访问层
│   ├── DocumentMapper.java
│   ├── CategoryMapper.java
│   └── UserMapper.java
├── entity/             # 实体类
│   ├── Document.java
│   ├── Category.java
│   └── User.java
├── dto/                # 数据传输对象
├── config/             # 配置类
│   ├── SecurityConfig.java
│   ├── RedisConfig.java
│   └── ElasticsearchConfig.java
└── utils/              # 工具类
    ├── FileUtils.java
    ├── DocumentConverter.java
    └── JwtUtils.java
```

#### 2.2.2 核心服务设计

**文档服务**:
```java
@Service
public class DocumentService {
    
    @Autowired
    private DocumentMapper documentMapper;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private SearchService searchService;
    
    public Document createDocument(DocumentDTO dto) {
        Document document = new Document();
        BeanUtils.copyProperties(dto, document);
        document.setCreateTime(new Date());
        
        // 保存到数据库
        documentMapper.insert(document);
        
        // 更新搜索索引
        searchService.indexDocument(document);
        
        // 清除相关缓存
        redisTemplate.delete("doc:category:" + document.getCategoryId());
        
        return document;
    }
    
    public Document getDocument(Long id) {
        // 先从缓存获取
        String cacheKey = "doc:" + id;
        Document cached = (Document) redisTemplate.opsForValue().get(cacheKey);
        if (cached != null) {
            return cached;
        }
        
        // 从数据库获取
        Document document = documentMapper.selectById(id);
        if (document != null) {
            // 缓存结果
            redisTemplate.opsForValue().set(cacheKey, document, 30, TimeUnit.MINUTES);
        }
        
        return document;
    }
}
```

**文件处理服务**:
```java
@Service
public class FileProcessService {
    
    public String convertWordToHtml(MultipartFile file) throws IOException {
        try (InputStream inputStream = file.getInputStream()) {
            XWPFDocument document = new XWPFDocument(inputStream);
            XHTMLOptions options = XHTMLOptions.create();
            
            ByteArrayOutputStream out = new ByteArrayOutputStream();
            XHTMLConverter.getInstance().convert(document, out, options);
            
            return out.toString("UTF-8");
        }
    }
    
    public String convertPdfToText(MultipartFile file) throws IOException {
        try (PDDocument document = PDDocument.load(file.getInputStream())) {
            PDFTextStripper stripper = new PDFTextStripper();
            return stripper.getText(document);
        }
    }
    
    public String convertMarkdownToHtml(String markdown) {
        Parser parser = Parser.builder().build();
        Node document = parser.parse(markdown);
        HtmlRenderer renderer = HtmlRenderer.builder().build();
        return renderer.render(document);
    }
}
```

### 2.3 数据库设计

#### 2.3.1 核心表结构

**用户表 (sys_user)**:
```sql
CREATE TABLE sys_user (
    id BIGINT PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    password VARCHAR(100) NOT NULL,
    email VARCHAR(100),
    real_name VARCHAR(50),
    role_type VARCHAR(20) NOT NULL DEFAULT 'EDITOR',
    status TINYINT DEFAULT 1,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_username (username),
    INDEX idx_role_type (role_type)
);
```

**文档分类表 (doc_category)**:
```sql
CREATE TABLE doc_category (
    id BIGINT PRIMARY KEY,
    parent_id BIGINT DEFAULT 0,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    sort_order INT DEFAULT 0,
    is_hidden TINYINT DEFAULT 0,
    product_type VARCHAR(50),
    version VARCHAR(50),
    create_user_id BIGINT,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_parent_id (parent_id),
    INDEX idx_product_version (product_type, version),
    INDEX idx_sort_order (sort_order)
);
```

**文档表 (document)**:
```sql
CREATE TABLE document (
    id BIGINT PRIMARY KEY,
    category_id BIGINT NOT NULL,
    title VARCHAR(200) NOT NULL,
    content LONGTEXT,
    summary TEXT,
    tags VARCHAR(500),
    version VARCHAR(50),
    product_type VARCHAR(50),
    file_path VARCHAR(500),
    file_size BIGINT DEFAULT 0,
    status VARCHAR(20) DEFAULT 'DRAFT',
    view_count BIGINT DEFAULT 0,
    download_count BIGINT DEFAULT 0,
    create_user_id BIGINT,
    update_user_id BIGINT,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    publish_time TIMESTAMP,
    INDEX idx_category_id (category_id),
    INDEX idx_product_version (product_type, version),
    INDEX idx_status (status),
    INDEX idx_create_time (create_time),
    FULLTEXT INDEX ft_title_content (title, content)
);
```

**权限表 (sys_permission)**:
```sql
CREATE TABLE sys_permission (
    id BIGINT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    resource_type VARCHAR(20) NOT NULL, -- CATEGORY, DOCUMENT
    resource_id BIGINT NOT NULL,
    permission_type VARCHAR(20) NOT NULL, -- READ, WRITE, DELETE
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    INDEX idx_resource (resource_type, resource_id),
    UNIQUE KEY uk_user_resource_permission (user_id, resource_type, resource_id, permission_type)
);
```

#### 2.3.2 索引优化策略

1. **主键索引**: 所有表使用BIGINT主键，支持高并发插入
2. **复合索引**: 针对常用查询条件建立复合索引
3. **全文索引**: 对文档标题和内容建立全文索引，支持中文搜索
4. **分区策略**: 大表按时间或产品类型进行分区

### 2.4 缓存架构设计

#### 2.4.1 缓存策略

**多级缓存架构**:
```
浏览器缓存 (1小时)
    ↓
Nginx缓存 (30分钟)
    ↓
Redis缓存 (15分钟)
    ↓
数据库
```

**缓存键设计**:
```
doc:{id}                    # 文档详情
doc:list:{categoryId}       # 文档列表
category:tree:{productType} # 分类树
user:info:{userId}          # 用户信息
search:{query}:{page}       # 搜索结果
```

#### 2.4.2 缓存更新策略

```java
@Service
public class CacheService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    public void evictDocumentCache(Long documentId, Long categoryId) {
        // 删除文档缓存
        redisTemplate.delete("doc:" + documentId);
        
        // 删除分类下的文档列表缓存
        redisTemplate.delete("doc:list:" + categoryId);
        
        // 删除搜索缓存
        Set<String> searchKeys = redisTemplate.keys("search:*");
        if (!searchKeys.isEmpty()) {
            redisTemplate.delete(searchKeys);
        }
    }
    
    @Cacheable(value = "documents", key = "#id")
    public Document getDocument(Long id) {
        return documentMapper.selectById(id);
    }
    
    @CacheEvict(value = "documents", key = "#document.id")
    public void updateDocument(Document document) {
        documentMapper.updateById(document);
    }
}
```

### 2.5 搜索架构设计

#### 2.5.1 Elasticsearch配置

**索引映射**:
```json
{
  "mappings": {
    "properties": {
      "id": { "type": "long" },
      "title": {
        "type": "text",
        "analyzer": "ik_max_word",
        "search_analyzer": "ik_smart"
      },
      "content": {
        "type": "text",
        "analyzer": "ik_max_word",
        "search_analyzer": "ik_smart"
      },
      "category_id": { "type": "long" },
      "product_type": { "type": "keyword" },
      "version": { "type": "keyword" },
      "tags": { "type": "keyword" },
      "create_time": { "type": "date" },
      "update_time": { "type": "date" }
    }
  }
}
```

**搜索服务**:
```java
@Service
public class SearchService {
    
    @Autowired
    private ElasticsearchRestTemplate elasticsearchTemplate;
    
    public SearchResult search(String query, int page, int size) {
        NativeSearchQueryBuilder queryBuilder = new NativeSearchQueryBuilder()
            .withQuery(QueryBuilders.multiMatchQuery(query, "title", "content"))
            .withHighlightFields(
                new HighlightBuilder.Field("title"),
                new HighlightBuilder.Field("content")
            )
            .withPageable(PageRequest.of(page, size));
            
        SearchHits<DocumentIndex> searchHits = elasticsearchTemplate
            .search(queryBuilder.build(), DocumentIndex.class);
            
        return convertToSearchResult(searchHits);
    }
    
    public void indexDocument(Document document) {
        DocumentIndex index = new DocumentIndex();
        BeanUtils.copyProperties(document, index);
        elasticsearchTemplate.save(index);
    }
}
```

### 2.6 安全架构设计

#### 2.6.1 认证授权流程

```
用户登录 → 验证用户名密码 → 生成JWT Token → 返回Token
    ↓
用户请求 → 验证Token → 解析用户信息 → 检查权限 → 执行业务逻辑
```

#### 2.6.2 权限控制实现

```java
@RestController
@RequestMapping("/api/documents")
public class DocumentController {
    
    @GetMapping("/{id}")
    @PreAuthorize("hasPermission(#id, 'DOCUMENT', 'READ')")
    public ResponseEntity<Document> getDocument(@PathVariable Long id) {
        Document document = documentService.getDocument(id);
        return ResponseEntity.ok(document);
    }
    
    @PostMapping
    @PreAuthorize("hasRole('ADMIN') or hasRole('EDITOR')")
    public ResponseEntity<Document> createDocument(@RequestBody DocumentDTO dto) {
        Document document = documentService.createDocument(dto);
        return ResponseEntity.ok(document);
    }
}
```

### 2.7 性能优化策略

#### 2.7.1 数据库优化

1. **连接池配置**:
```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
```

2. **查询优化**:
- 使用分页查询避免大结果集
- 建立合适的索引
- 使用查询缓存
- 避免N+1查询问题

#### 2.7.2 应用层优化

1. **异步处理**:
```java
@Async
public CompletableFuture<Void> processLargeFile(MultipartFile file) {
    // 异步处理大文件
    return CompletableFuture.completedFuture(null);
}
```

2. **批量操作**:
```java
public void batchInsertDocuments(List<Document> documents) {
    documentMapper.insertBatch(documents);
}
```

#### 2.7.3 前端优化

1. **代码分割**:
```javascript
const DocumentEditor = () => import('@/views/DocumentEditor.vue')
```

2. **虚拟滚动**:
```vue
<virtual-list
  :data-sources="documents"
  :data-component="DocumentItem"
  :estimate-size="80"
/>
```

## 3. 部署架构

### 3.1 容器化部署

**Docker Compose配置**:
```yaml
version: '3.8'
services:
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./dist:/usr/share/nginx/html
  
  app:
    build: .
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
    depends_on:
      - dm8
      - redis
      - elasticsearch
  
  dm8:
    image: dameng/dm8:latest
    ports:
      - "5236:5236"
    volumes:
      - dm8_data:/opt/dmdbms/data
  
  redis:
    image: redis:alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
  
  elasticsearch:
    image: elasticsearch:7.17.0
    ports:
      - "9200:9200"
    environment:
      - discovery.type=single-node
    volumes:
      - es_data:/usr/share/elasticsearch/data

volumes:
  dm8_data:
  redis_data:
  es_data:
```

### 3.2 监控和日志

**监控配置**:
```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'dameng-doc-center'
    static_configs:
      - targets: ['app:8080']
    metrics_path: '/actuator/prometheus'
```

**日志配置**:
```xml
<!-- logback-spring.xml -->
<configuration>
    <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>logs/dameng-doc-center.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>logs/dameng-doc-center.%d{yyyy-MM-dd}.log</fileNamePattern>
            <maxHistory>30</maxHistory>
        </rollingPolicy>
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <root level="INFO">
        <appender-ref ref="STDOUT" />
        <appender-ref ref="FILE" />
    </root>
</configuration>
```

## 4. 总结

本技术架构设计基于现代化的微服务架构理念，采用前后端分离的设计模式，确保系统的可扩展性、可维护性和高性能。主要特点包括：

1. **技术栈现代化**: 使用Vue.js 3、Spring Boot等主流技术
2. **数据库适配**: 完全支持DM8数据库和DMCDM缓存
3. **性能优化**: 多级缓存、异步处理、索引优化
4. **安全可靠**: JWT认证、RBAC权限控制、数据加密
5. **易于部署**: Docker容器化、自动化部署
6. **监控完善**: 日志收集、性能监控、告警机制

该架构能够满足达梦在线文档中心的所有核心需求，并为后续功能扩展提供良好的基础。